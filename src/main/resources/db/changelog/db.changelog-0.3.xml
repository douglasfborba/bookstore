<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
	
	<changeSet author="douglas.borba" id="12022019171745-1">
		<createTable tableName="dis_avaliacao">
			<column name="id" type="bigint">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="codigo" type="varchar(100)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="rating" type="int">
				<constraints nullable="false" />
			</column>
			<column name="usuario" type="varchar(50)">
				<constraints nullable="false" />
			</column>
			<column name="comentario_id" type="int">
				<constraints nullable="true" foreignKeyName="fk_com_aval"/>
			</column>	
			<column name="produto_id" type="int">
				<constraints nullable="true" foreignKeyName="fk_prod_aval"/>
			</column>			
		</createTable>
		<addForeignKeyConstraint baseColumnNames="comentario_id" baseTableName="dis_avaliacao"
	            constraintName="fk_aval_com" deferrable="true" initiallyDeferred="true"
	            onDelete="CASCADE" onUpdate="RESTRICT" referencedColumnNames="id"
	            referencedTableName="dis_comentario"/>
	    <addForeignKeyConstraint baseColumnNames="produto_id" baseTableName="dis_avaliacao"
	            constraintName="fk_aval_prod" deferrable="true" initiallyDeferred="true"
	            onDelete="CASCADE" onUpdate="RESTRICT" referencedColumnNames="id"
	            referencedTableName="dis_produto"/>
	</changeSet>
	
	<changeSet author="douglas.borba" id="12022019172405-1">
		<createSequence sequenceName="dis_aval_seq" 
			ordered="true" cycle="false" minValue="1" maxValue="2000" 
			startValue="1" incrementBy="1" />
	</changeSet>
	
	<changeSet author="douglas.borba" id="12022019172435-1">
		<sql endDelimiter="/">
			CREATE OR REPLACE TRIGGER dis_aval_nextid 
				BEFORE INSERT ON dis_avaliacao
				REFERENCING	OLD AS old NEW AS new
				FOR EACH ROW
			DECLARE
				v_id NUMBER(38, 0);
			BEGIN
				IF :new.id IS NULL THEN
					SELECT dis_aval_seq.NEXTVAL INTO v_id FROM dual;
					:new.id := v_id;
				END IF;
			END dis_aval_nextid;
		</sql>
	</changeSet>
	
	<changeSet author="douglas.borba" id="05022019105850-1">
		<insert tableName="dis_avaliacao" schemaName="sdbanco">
			<column name="valor" valueNumeric="3.5" />			
			<column name="produto_id" valueNumeric="1" />		
		</insert>
		<insert tableName="dis_historico" schemaName="sdbanco">
			<column name="preco" valueNumeric="42.90" />			
			<column name="comentario_id" valueNumeric="2" />			
		</insert>
	</changeSet>			

</databaseChangeLog>